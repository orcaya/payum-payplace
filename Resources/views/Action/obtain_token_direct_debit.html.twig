<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{% block title %}SEPA Lastschrift{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .payment-container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .payment-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .payment-form {
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        .iframe-field {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            min-height: 40px;
            background-color: #fafafa;
            position: relative;
        }
        .iframe-field.ifs-focused {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        .iframe-field.ifs-valid {
            border-color: #4CAF50;
        }
        .iframe-field.ifs-invalid {
            border-color: #f44336;
        }
        .submit-section {
            text-align: center;
            margin-top: 30px;
        }
        #submitButton {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 200px;
        }
        #submitButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #submitButton:not(:disabled):hover {
            background-color: #45a049;
        }
        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #d32f2f;
        }
        .info-message {
            color: #388e3c;
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }
        .hidden {
            display: none;
        }
        #bicRow {
            display: none;
        }
        #bicRow.show {
            display: block;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .payment-method-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }
        .payment-method-info h3 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }
        .payment-method-info p {
            margin: 0;
            color: #666;
        }
        .sepa-info {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .sepa-info h4 {
            margin: 0 0 10px 0;
            color: #856404;
        }
        .sepa-info p {
            margin: 0;
            font-size: 14px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="payment-header">
            {% block header %}
            <h2>üè¶ SEPA Lastschrift</h2>
            <p>Sichere Zahlung per Bankeinzug</p>
            {% endblock %}
        </div>

        {% if model.posherr is defined and model.posherr != '0' %}
        <div class="error-message">
            <strong>Fehler:</strong> {{ model.rmsg|default('Ein Fehler ist aufgetreten') }}
        </div>
        {% endif %}

        <div class="payment-method-info">
            <h3>SEPA Lastschrift</h3>
            <p>Sichere Zahlung direkt von Ihrem Bankkonto mit SEPA-Lastschriftverfahren.</p>
        </div>

        <div class="sepa-info">
            <h4>‚ÑπÔ∏è SEPA-Lastschriftmandat</h4>
            <p>Mit der Eingabe Ihrer Kontodaten erteilen Sie ein SEPA-Lastschriftmandat f√ºr diese Zahlung. Die Abbuchung erfolgt innerhalb der n√§chsten Werktage.</p>
        </div>

        <div class="info-message">
            <strong>Sicher:</strong> Ihre Kontodaten werden verschl√ºsselt direkt an Payplace √ºbertragen.
        </div>

        <!-- SEPA Lastschrift-Formular -->
        <form id="bankAccountForm" class="payment-form">
            <div class="form-group">
                <label for="iframeAccountHolder">Kontoinhaber</label>
                <div id="iframeAccountHolder" class="iframe-field"></div>
            </div>
            
            <div class="form-group">
                <label for="iframeIban">IBAN</label>
                <div id="iframeIban" class="iframe-field"></div>
            </div>
            
            <div class="form-group" id="bicRow">
                <label for="iframeBic">BIC</label>
                <div id="iframeBic" class="iframe-field"></div>
            </div>
        </form>

        <div class="submit-section">
            <button id="submitButton" type="button" disabled>üè¶ Lastschrift durchf√ºhren</button>
        </div>

        <!-- Hidden form f√ºr Token-√úbertragung -->
        <form id="tokenForm" method="post" action="{{ actionUrl }}" style="display: none;">
            <input type="hidden" name="token" id="token-field">
            <input type="hidden" name="payment_method" value="elv">
            <input type="hidden" name="payment_type" id="payment-type-field">
            <input type="hidden" name="ppan" id="ppan-field">
        </form>

        <div id="loading" class="loading hidden">
            <p>SEPA Lastschrift wird verarbeitet...</p>
        </div>
    </div>

    <!-- Payplace integration.js laden -->
    <script>
        // Debug-Modus f√ºr bessere Fehlerdiagnose
        const DEBUG = true;
        
        function debugLog(message, data = null) {
            if (DEBUG) {
                console.log('[Payplace Debug]', message, data || '');
            }
        }

        // Globale Variable f√ºr die iframe-Instanz
        let bankAccountInstance = null;

        // Dynamisch integration.js laden
        function loadPayplaceScript() {
            debugLog('Loading Payplace script...');
            const script = document.createElement('script');
            const baseUrl = {{ model.sandbox|default(true) ? 'true' : 'false' }} ? 
                'https://testsystem.payplace.de' : 
                'https://system.payplace.de';
            script.src = baseUrl + '/web-ifs/assets/1.2/integration.js';
            script.onload = function() {
                debugLog('Payplace script loaded successfully');
                initializePayplace();
            };
            script.onerror = function() {
                debugLog('Error loading Payplace script');
                document.getElementById('loading').innerHTML = '<div class="error-message">Fehler beim Laden des Payplace-Skripts</div>';
                document.getElementById('loading').classList.remove('hidden');
            };
            document.head.appendChild(script);
        }

        // Payplace SEPA-Integration initialisieren
        function initializePayplace() {
            debugLog('Initializing Payplace...');
            
            const clientSession = '{{ model.clientSession|default('') }}';
            const clientConfiguration = '{{ model.clientConfiguration|default('') }}';
            
            debugLog('Client session:', clientSession);
            debugLog('Client configuration:', clientConfiguration);
            
            if (!clientSession || !clientConfiguration) {
                debugLog('Error: Missing clientSession or clientConfiguration');
                document.getElementById('loading').innerHTML = '<div class="error-message">Konfigurationsfehler: clientSession oder clientConfiguration fehlt</div>';
                document.getElementById('loading').classList.remove('hidden');
                return;
            }

            // Pr√ºfen ob integration object verf√ºgbar ist
            if (typeof integration === 'undefined') {
                debugLog('Error: integration object not available');
                document.getElementById('loading').innerHTML = '<div class="error-message">Payplace integration object nicht verf√ºgbar</div>';
                document.getElementById('loading').classList.remove('hidden');
                return;
            }

            // DOM-Elemente
            const submitButton = document.getElementById('submitButton');
            const tokenForm = document.getElementById('tokenForm');
            const bicRow = document.getElementById('bicRow');

            // Optionen f√ºr SEPA-Lastschrift
            const bankAccountOptions = {
                clientSession: clientSession,
                clientConfiguration: clientConfiguration,
                type: 'bankAccount',
                fields: {
                    holder: {
                        selector: '#iframeAccountHolder', 
                        placeholder: 'Max Mustermann'
                    },
                    iban: {
                        selector: '#iframeIban',
                        placeholder: 'DE89 3704 0044 0532 0130 00'
                    },
                    bic: {
                        selector: '#iframeBic',
                        placeholder: 'COBADEFFXXX'
                    }
                }
            };

            debugLog('Initializing integration with options:', bankAccountOptions);

            // SEPA-Integration initialisieren
            integration.initialize(bankAccountOptions).then(function(ifsInstance) {
                debugLog('Integration initialized successfully', ifsInstance);
                bankAccountInstance = ifsInstance;

                // Events abonnieren
                ifsInstance.on('submitRequest', function(event) {
                    debugLog('submitRequest event triggered', event);
                    handleSubmitRequest();
                });

                ifsInstance.on('ibanTypeChange', function(event) {
                    debugLog('ibanTypeChange event', event);
                    // BIC-Feld anzeigen/verstecken basierend auf IBAN
                    if (event.fields.bicMandatory) {
                        bicRow.classList.add('show');
                    } else {
                        bicRow.classList.remove('show');
                    }
                });

                ifsInstance.on('formValidationChange', function(event) {
                    debugLog('formValidationChange event', event);
                    submitButton.disabled = !event.valid || !event.completed;
                });

                // Weitere Events f√ºr Debugging
                ifsInstance.on('activeStateChange', function(event) {
                    debugLog('activeStateChange event', event);
                });

                ifsInstance.on('ready', function(event) {
                    debugLog('ready event', event);
                });

                // Initial state
                submitButton.disabled = true;
                
            }).catch(function(error) {
                debugLog('Error initializing integration:', error);
                document.getElementById('loading').innerHTML = '<div class="error-message">Fehler bei der SEPA-Initialisierung: ' + error + '</div>';
                document.getElementById('loading').classList.remove('hidden');
            });

            // Submit-Handler Funktion
            function handleSubmitRequest() {
                debugLog('Starting token creation...');
                
                if (!bankAccountInstance) {
                    debugLog('Error: bankAccountInstance not available');
                    alert('Integration nicht verf√ºgbar');
                    return;
                }

                if (!bankAccountInstance.isActive()) {
                    debugLog('Error: integration not active');
                    alert('Integration nicht aktiv');
                    return;
                }

                if (!bankAccountInstance.isValid()) {
                    debugLog('Error: form not valid');
                    alert('Formular nicht vollst√§ndig ausgef√ºllt');
                    return;
                }

                document.getElementById('loading').classList.remove('hidden');
                submitButton.disabled = true;

                bankAccountInstance.createToken(function(createTokenErr, createTokenResponse) {
                    debugLog('createToken callback', { error: createTokenErr, response: createTokenResponse });
                    
                    if (createTokenErr) {
                        debugLog('Token creation error:', createTokenErr);
                        document.getElementById('loading').classList.add('hidden');
                        submitButton.disabled = false;
                        alert('Fehler bei der Token-Erstellung: ' + createTokenErr);
                        return;
                    }

                    if (!createTokenResponse || !createTokenResponse.token) {
                        debugLog('Invalid token response:', createTokenResponse);
                        document.getElementById('loading').classList.add('hidden');
                        submitButton.disabled = false;
                        alert('Ung√ºltige Antwort von Payplace');
                        return;
                    }

                    // Token-Daten setzen
                    debugLog('Setting token data:', createTokenResponse);
                    document.getElementById('token-field').value = createTokenResponse.token;
                    document.getElementById('payment-type-field').value = createTokenResponse.type || 'bankAccount';
                    
                    // PPAN f√ºr ELV-Zahlungen
                    if (createTokenResponse.info && createTokenResponse.info.ppan) {
                        document.getElementById('ppan-field').value = createTokenResponse.info.ppan;
                    }

                    debugLog('Submitting form...');
                    // Form absenden
                    tokenForm.submit();
                });
            }

            // Submit-Button Event
            submitButton.addEventListener('click', function() {
                debugLog('Submit button clicked');
                handleSubmitRequest();
            });
        }

        // Script laden wenn DOM bereit
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM loaded, starting initialization...');
            loadPayplaceScript();
        });
    </script>
</body>
</html> 